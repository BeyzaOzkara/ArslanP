{% extends 'adminlte/base.html' %}
{% block body_class %}
  {% block bodyclass %}
    sidebar-collapse
  {% endblock %}
{% endblock %}

{% load static %}

{% block title %}
  Arslan Alüminyum
{% endblock %}

{% block stylesheets %}
  {% include 'adminlte/lib/_styles.html' %}
  <link rel="stylesheet" type="text/css" href="{% static 'tabulator/dist/css/tabulator_bootstrap5.min.css' %}">
  
  <style>
    .callout.callout-info {
        border-width: 40px; /* Adjust the size as needed */
        border-color: #17a2b8; /* Change the color if necessary */
    }
  </style>

{% endblock %}

{% block content %}
    <h1 class="pl-4">Bildirimler</h1>
    <hr>
    <div class="card">
      <div class="card-header">
        <h3>TABULATOR DENEME</h3>
      </div>
      <div class="card-body">
        <div id="tabNoti"></div>
      </div>
    </div>

    <div class="container-fluid">
      <div class="row px-4">
        <div class="col alert alert-info">
          <h5><i class="icon fas fa-info"></i> Info!</h5>
          Info preview.
        </div>
      </div>

      <div class="row">
        <div class="col-md-6">
            <h2 class="pl-4">Yeni YUDA</h2>
            <div class="row row-cols-2">
                {% for yuda in yudas %}
                <div class="col px-4">
                  <div class="notification-item w-100">
                    <div class="notification-border" id="nb{{ yuda.id}}" style="background-color: {{ yuda.is_marked|yesno:'blue,#e0e0e0' }}; color: {{ yuda.is_marked|yesno:'blue,#e0e0e0' }}" onclick="markAsMarked({{ yuda.id }})">
                      <span style="opacity: 0;">&nbsp;</span>
                    </div>
                    <div class="notification-content"id="nc{{ yuda.id}}" onclick="markNotificationAsRead({{ yuda.id }})">
                        <div class="d-flex justify-content-between">
                            <div>
                                <i class="fas fa-file mr-2"></i>
                                {{ yuda.Kisi }}
                            </div>
                            <small>{{ yuda.timestamp }}</small>
                        </div>
                        <div class="notiMessage">{{ yuda.message }}</div>
                        <div class="dropdown-divider"></div>
                    </div>
                  </div>
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="col-md-6">
            <h2 class="pl-4">Yorumlar</h2>
            <div class="row row-cols-2">
                {% for ycomment in ycomments %}
                <div class="col px-4">
                  <div class="card">
                    <div class="card-header">
                      <div class="d-flex justify-content-between">
                        <div>
                            <i class="fas fa-file mr-2"></i>
                            {{ ycomment.Kisi }}
                        </div>
                        <small>{{ ycomment.timestamp }}</small>
                      </div>
                    </div>
                    <div class="card-body">
                      <div class="notification-item w-100">
                        <div class="notification-border" id="nb{{ ycomment.id}}" style="background-color: {{ ycomment.is_marked|yesno:'blue,#e0e0e0' }}; color: {{ ycomment.is_marked|yesno:'blue,#e0e0e0' }}" onclick="markAsMarked({{ ycomment.id }})">
                          <span style="opacity: 0;">&nbsp;</span>
                        </div>
                        <div class="notification-content" id="nc{{ ycomment.id}}" onclick="markNotificationAsRead({{ ycomment.id }})">
                            
                            <div class="notiMessage">{{ ycomment.comment }}</div>
                            <div class="dropdown-divider"></div>
                        </div>
                      </div>
                    </div>
                    
                  </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    </div>
{% endblock %}

{% block javascript %}
{% include 'adminlte/lib/_scripts.html' %}
<script src="{% static 'tabulator/dist/js/tabulator.js' %} "></script>

<script>
  var data = JSON.parse('{{ notifications|escapejs }}');

  var notiMessages = document.getElementsByClassName('notiMessage');
  for (var i = 0; i < notiMessages.length; i++) {
      notiMessages[i].innerHTML = notiMessages[i].textContent;
  };

  function markNotificationAsRead(notificationId) {
    window.location.href = `/notif/${notificationId}`;
    const data = {
        type: 'mark_as_read',
        notification_id: notificationId
    };
    socket.send(JSON.stringify(data));
  };

  function markAsMarked(notificationId) {
    var notificationBorder = $(`#nb${notificationId}`);
    //if class has blue remove if it doesn't have add
    var isCurrentlyBlue = notificationBorder.css('background-color') === 'rgb(0, 0, 255)'; // Checking if the color is blue

    if (isCurrentlyBlue) {
        notificationBorder.css('background-color', '#e0e0e0'); // Set to grey if it's currently blue
    } else {
        notificationBorder.css('background-color', 'blue'); // Set to blue if it's not
    }

    const data = {
        type: 'mark_as_marked',
        notification_id: notificationId,
    };
    socket.send(JSON.stringify(data));

  }

  var tableNoti = new Tabulator("#tabNoti", {
    height:"500px",
    layout:"fitDataFill",
    placeholder:"Bildirimler",
    data: data,
    rowFormatter:function(row){
        if(row.getData().col == "blue"){
            row.getElement().style.backgroundColor = "#1e3b20";
        }
    },
    columns:[
            {title:"", field:"col_marked" ,formatter:"color", width:50},
            {title:"Kim", field:"Kisi"},
            {title:"İçerik", field:"message"},
            {title:"Zaman", field:"timestamp"},
    ],
  });

  tableNoti.on("rowClick", (e, row) => {
    var nId = row.getData().id; // Get the ID from the row data
    window.location.href = '/notif/' + nId; // Redirect the user to the notification page
  });
  
</script>

{% endblock %}