{% extends 'adminlte/base.html' %}
{% block body_class %}{% block bodyclass %}sidebar-collapse {% endblock %}{% endblock %}

{% block title %}Arslan Alüminyum{% endblock %}

{% block content %}
<h1>Arslan Alüminyum</h1>
<h1>~~YAPIM AŞAMASINDA~~</h1>
<h2>{{type}}</h2>
<h2>{{no}}</h2>
<p id="de"></p>
<input type="button" name="deneme" id="btnDeneme" onclick="sendDeneme()">

{% endblock %}

{% block javascript %}

{% include 'adminlte/lib/_scripts.html' %}
<script>
    const socket = new WebSocket('ws://arslan/ws/notifications/');
    console.log(socket);

    socket.onopen = function(e) {
        console.log("open");
    }
    
    socket.onclose = function(e) {
        console.log("close")
    };

    const notificationsDropdown = document.getElementById('notification-dropdown');
    const notificationList = document.getElementById('notification-list');
    const notificationCount = document.getElementById('notification-count');

    socket.onmessage = function(event) {
        const data = JSON.parse(event.data);
        console.log(data);
        if (data.type === 'notification') {
            const notification = data.notification;
            const notificationElement = document.createElement('a');
            notificationElement.classList.add('dropdown-item');
            notificationElement.href = '#'; // Add the link if needed
            notificationElement.innerHTML = `
                <div class="d-flex justify-content-between">
                    <div>${notification.subject}</div>
                    <small>${notification.timestamp}</small>
                </div>
                <div>${notification.message}</div>
            `;
            notificationList.appendChild(notificationElement);

            // Update notification count
            if (notificationCount.innerText == "") {notificationCount.innerText = 0;};
            notificationCount.textContent = parseInt(notificationCount.textContent) + 1;
        }
    };

    // socket.onmessage = function(event) { //düzenlenecek
    //     const data = JSON.parse(event.data);
    //     console.log("DATA: ", data);
    //     document.getElementById('de').innerHTML = data.message;

    //     if (data.type != "connection_established") {
    //         const notificationList = document.getElementById('notification-list');
    //         const nCount = document.getElementById('notification-count');

    //         // // Update notification count
    //         if (nCount.innerText == "") {nCount.innerText = 0;};
    //         nCount.innerText = parseInt(nCount.innerText) + 1; //data.message;

    //         // Add new notification to the list
    //         const newNotification = document.createElement('a');
    //         newNotification.classList.add('dropdown-item');
    //         newNotification.href = '#';
    //         newNotification.innerHTML = `<i class="fas fa-envelope mr-2"></i> ${data.message}<span class="float-right text-muted text-sm">3 dk</span>`;
    //         notificationList.insertBefore(newNotification, data.firstChild);
    //     }
        
    // };

    function markAsRead(notificationId) { //onclick markAsRead
        const message = {
            type: 'mark_as_read',
            notification_id: notificationId,
        };
        socket.send(JSON.stringify(message));
    } //markAsRead(123);


    function sendDeneme() {
        
        $.ajax({
            url: 'deneme',
            method: 'GET',
            success: function(response){
                console.log("Cevap: " + response.message);
            },
            error: function (error) {
            console.error('Error :', error);
            }
        });
    };

</script>
{% endblock %}