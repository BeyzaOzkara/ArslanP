{% extends 'adminlte/base.html' %}

{% block body_class %}
  {% block bodyclass %}
    sidebar-collapse
  {% endblock %}
{% endblock %}

{% load static %}

{% block title %}
  Arslan Alüminyum
{% endblock %}

{% block stylesheets %}
  {% include 'adminlte/lib/_styles.html' %}
  <link rel="stylesheet" type="text/css" href="{% static 'tabulator/dist/css/tabulator_bootstrap5.min.css' %}">

  <style>

    .content-wrapper {
      overflow: hidden;
    }

    .info-box {
      text-align: left !important;
      padding-right: 0%;
      padding-left: 0%;
    }

    #tableMeydan {
      max-height: 100%;
      overflow: auto;
    }


.base-timer {
  position: relative;
  width: 11vh;
  height: 11vh;
}

.base-timer__svg {
  transform: scaleX(-1);
}

.base-timer__circle {
  fill: none;
  stroke: none;
}

.base-timer__path-elapsed {
  stroke-width: 7px;
  stroke: grey;
}

.base-timer__path-remaining {
  stroke-width: 7px;
  stroke-linecap: round;
  transform: rotate(90deg);
  transform-origin: center;
  transition: 1s linear all;
  fill-rule: nonzero;
  stroke: currentColor;
}

.base-timer__path-remaining.green {
  color: rgb(65, 184, 131);
}

.base-timer__path-remaining.orange {
  color: orange;
}

.base-timer__path-remaining.red {
  color: red;
}

.base-timer__label {
  position: absolute;
  width: 11vh;
  height: 11vh;
  top: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 4vh;
}

.timer {
  float: right;
  width: 11vh;
  height: 11vh;
  
}


  </style>

{% endblock %}

{% block content %}

  <div class="row cards-row">
    <div class="col-md-2 ">
      <div class="card h-100 bg-gradient-info text-white" style="text-align: center;">
        <div class="card-body 1 align-items-center" id="cardBody1">1.GÖZ            <!-- Info Box with Progress Bar -->
          </div>
        </div>
    </div>
    <div class="col-md-2">
      <div class="card h-100 overflow-auto bg-primary text-white" style="text-align: center;">
        <div class="card-body 2" id="cardBody2">2. GÖZ</div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card h-100 overflow-auto bg-secondary text-white"  style="text-align: center;">
        <div class="card-body 3" id="cardBody3">3. GÖZ</div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card h-100 overflow-auto bg-success text-white" style="text-align: center;">
        <div class="card-body 4" id="cardBody4">4. GÖZ
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card h-100 overflow-auto bg-info text-white" style="text-align: center;">
        <div class="card-body 5" id="cardBody5">5. GÖZ</div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card h-100 overflow-auto bg-danger text-white" style="text-align: center;">
        <div class="card-body 6" id="cardBody6">6. GÖZ</div>
      </div>
    </div>
  </div>

  <div class="row tabulator-row">
    <div class="col-md-12">
      <div class="card h-100 overflow-auto" >
        <div class="card-body">
          <div id="tableMeydan"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="kalipModal" tabindex="-1" aria-labelledby="kalipModalLabel" style="display: none;" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <div class="col-lg-10">
            <h5 class="modal-title">Fırına Ekle</h5>
          </div>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">

            <div class="container" style="text-align: center;">
            <form action="" method="post" id="ekleForm">
            {% csrf_token %}
            
              <input type="text" class="form-control-lg" name="kalipNo" value="" readonly id="kalipNo" style="margin-bottom: 2%; text-align: center;">
              → →
              <input type="text" class="form-control-lg" name="firinNo" value="" readonly id="firinNo" style="margin-bottom: 2%; text-align: center;">

            </form>
              <div class="row goz">
                <div class="col-md-2">
                  <div class="card bg-primary text-white">
                    <label for="check1">
                      <div class="card-body"><input class="check-input" type="radio" name="foo" id="check1" value="1. GÖZ" aria-label="...">  GÖZ 1</div>
                    </label>
                  </div>
                </div>
                <div class="col-md-2">
                  <div class="card bg-secondary text-white">
                    <label for="check2">
                      <div class="card-body"><input class="check-input" type="radio" name="foo" id="check2" value="2. GÖZ" aria-label="...">  GÖZ 2</div>
                    </label>
                  </div>
                </div>
                <div class="col-md-2">
                  <div class="card bg-success text-white">
                    <label for="check3">
                      <div class="card-body"><input class="check-input" type="radio" name="foo" id="check3" value="3. GÖZ" aria-label="...">  GÖZ 3</div>
                    </label>
                  </div>
                </div>
                <div class="col-md-2">
                  <div class="card bg-danger text-white">
                    <label for="check4">
                      <div class="card-body"><input class="check-input" type="radio" name="foo" id="check4" value="4. GÖZ" aria-label="...">  GÖZ 4</div>
                    </label>
                  </div>
                </div>
                <div class="col-md-2">
                  <div class="card bg-warning text-white">
                    <label for="check5">
                      <div class="card-body"><input class="check-input" type="radio" name="foo" id="check5" value="5. GÖZ" aria-label="...">  GÖZ 5</div>
                    </label>
                  </div>
                </div>
                <div class="col-md-2">
                  <div class="card bg-info text-white">
                    <label for="check6">
                      <div class="card-body"><input class="check-input" type="radio" name="foo" id="check6" value="6. GÖZ" aria-label="...">  GÖZ 6</div>
                    </label>
                  </div>
                </div>
              </div>
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" id="btnFirinaEkle" class="btn btn-primary">Ekle</button>
        </div>
      </div>
    </div>
  </div>


{% endblock %}

{% block extra_js %}

<script>

    
  function alignModal() {
    var modalDialog = $(this).find(".modal-dialog");
    modalDialog.css("margin-top", Math.max(0, 
    ($(window).height() - modalDialog.height()) / 2));
  };


  const cardBody1 =  $('#cardBody1');
  const cardBody2 =  $('#cardBody2');
  const cardBody3 =  $('#cardBody3');
  const cardBody4 =  $('#cardBody4');
  const cardBody5 =  $('#cardBody5');
  const cardBody6 =  $('#cardBody6');
  const cardList = [cardBody1, cardBody2, cardBody3, cardBody4, cardBody5, cardBody6]
  
  const renderData = (data) => { //cardların içine uyacak şekilde info boxlar oluşturulacak
    //gelen datanın konumuna bağlı card doldurulacak
    cardBody1.empty();  // Önceki verileri temizle
    cardBody2.empty();
    cardBody3.empty();
    cardBody4.empty();
    cardBody5.empty();
    cardBody6.empty();

    for(i=1; i<7; i++){
      const header = $('<h2 class="text-center"></h3>').html(`${i}. GÖZ`);
      cardBody = cardList[i-1];
      cardBody.append(header);
    };

    data.forEach(item => { // Verileri render et...
      //console.log(item.kalipVaris__locationName);
      let locationName = item.kalipVaris__locationName;
      let hZamani = item.hareketTarihi;
      let count = 1;
      for (i=1; i<7; i++) {
        if(locationName.indexOf(i) !== -1){
          cardBody = cardList[i-1];
          let gozName = i + ". GÖZ"
          let profilNo ="";
          let yanNo = "";
          if (item.kalipNo.indexOf("-") != -1){
            profilNo = (item.kalipNo).substring(0, item.kalipNo.indexOf("-"));
            yanNo = (item.kalipNo).slice(item.kalipNo.indexOf("-")+1);
          }
          else {
            profilNo = item.kalipNo;
            yanNo = "";
          }

          let timerId = i+"Goz"+ count;
          //infobox create
          //o card için cardBody.append(box)
          const box = $('<div class="info-box border-0" style="width: 100%; color: black; overflow: hidden;"></div>').html(`
          <div class="info-box-content">
            <div class="row">
                <div class="container col-lg-6">
                  <span class="info-box-number" style="font-size: 3.7vh; text-align:center;">${profilNo}</span>
                  <span class="info-box-number" style="font-size: 3.7vh; text-align:center;">${yanNo}</span>
                </div>
                <div class="container col-lg-6" style= "margin-top:auto; margin-bottom:auto;">
                  <div class="timer" data-hareket-zamani="${item.hareketTarihi}"></div>
                </div>
            </div>
            </div><!-- /.info-box-content -->
          `);
          cardBody.append(box);
          count += 1;
          break;
        }
      };
      
      const FULL_DASH_ARRAY = 283;
      const WARNING_THRESHOLD = 3600; // 1 hour
      const ALERT_THRESHOLD = 1800;  // 30 minutes

      const COLOR_CODES = {
        info: {
          color: "green"
        },
        warning: {
          color: "orange",
          threshold: WARNING_THRESHOLD
        },
        alert: {
          color: "red",
          threshold: ALERT_THRESHOLD
        }
      };

      const TIME_LIMIT = 86400;
      let timerInterval = null;
      let remainingPathColor = COLOR_CODES.info.color; 

      document.querySelectorAll(".timer").forEach(function(item){
        let hareketZamani = item.getAttribute('data-hareket-zamani');
        console.log(hareketZamani);
        let hareketDate = new Date(hareketZamani);
        let currentDate = new Date();
        let differenceInMilliseconds = currentDate - hareketDate;
        let differenceInSeconds = Math.floor(differenceInMilliseconds / 1000);
        console.log(differenceInSeconds);
        let timePassedForThisTimer = differenceInSeconds;
        let timeLeftForThisTimer = TIME_LIMIT - timePassedForThisTimer;
        item.innerHTML = `
          <div class="base-timer">
            <svg class="base-timer__svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
              <g class="base-timer__circle">
                <circle class="base-timer__path-elapsed" cx="50" cy="50" r="45"></circle>
                <path
                  id="base-timer-path-remaining"
                  stroke-dasharray="283"
                  class="base-timer__path-remaining ${remainingPathColor}"
                  d="
                    M 50, 50
                    m -45, 0
                    a 45,45 0 1,0 90,0
                    a 45,45 0 1,0 -90,0
                  "
                ></path>
              </g>
            </svg>
            <span id="base-timer-label" class="base-timer__label">${formatTime(
              timeLeftForThisTimer
            )}</span>
          </div>
          `;
      })

      startTimer();

      function onTimesUp() {
        clearInterval(timerInterval);
      }

      function startTimer() {
        timerInterval = setInterval(() => {
          document.querySelectorAll(".timer").forEach(function(item){
            let hareketZamani = item.getAttribute('data-hareket-zamani');
            let hareketDate = new Date(hareketZamani);
            let currentDate = new Date();
            let differenceInMilliseconds = currentDate - hareketDate;
            let differenceInSeconds = Math.floor(differenceInMilliseconds / 1000);
            let timePassedForThisTimer = differenceInSeconds;
            let timeLeftForThisTimer = TIME_LIMIT - timePassedForThisTimer;

            let label = item.querySelector('.base-timer__label');
            label.innerHTML = formatTime(timeLeftForThisTimer);

            setCircleDasharray(timeLeftForThisTimer);
            setRemainingPathColor(timeLeftForThisTimer);

            if (timeLeftForThisTimer === 0) {
              onTimesUp();
            }
        });
        }, 1000);
      }

      function formatTime(time) {
        console.log("Time to format:", time);
        const hours = Math.floor(time / 3600);
        let minutes = Math.floor((time % 3600) / 60);
        let seconds = time % 60;

        if (minutes < 10) {
            minutes = `0${minutes}`;
        }

        return `${hours}:${minutes}`;
      }

      function setRemainingPathColor(timeLeft) {
        const { alert, warning, info } = COLOR_CODES;
        if (timeLeft <= alert.threshold) { //classname ile array dönüyor foreache al
          document.querySelectorAll(".base-timer__path-remaining").forEach(function(item){
            item.classList.remove(warning.color);
            item.classList.add(alert.color);
          });
        } else if (timeLeft <= warning.threshold) {
          document.querySelectorAll(".base-timer__path-remaining").forEach(function(item){
            item.classList.remove(info.color);
            item.classList.add(warning.color);
          });
        }
      }

      function calculateTimeFraction(timeLeftForThisTimer) {
        const rawTimeFraction = timeLeftForThisTimer / TIME_LIMIT;
        return rawTimeFraction - (1 / TIME_LIMIT) * (1 - rawTimeFraction);
      }

      function setCircleDasharray(timeLeftForThisTimer) {
        const circleDasharray = `${(
          calculateTimeFraction(timeLeftForThisTimer) * FULL_DASH_ARRAY
        ).toFixed(0)} 283`;
        document.querySelectorAll("base-timer__path-remaining").forEach(function(item){
          item.setAttribute("stroke-dasharray", circleDasharray);
        });
      } 

    });


    $(".modal").on("shown.bs.modal", alignModal);

    $(window).on("resize", function() {
      $(".modal:visible").each(alignModal);
    });

    document.getElementsByClassName("content-wrapper")[0].id = "contentw";
    var el = document.getElementById("contentw").style.minHeight.slice(0, -2);
    
    var header = $(".content-header").height();
    var footer = $(".main-footer").height();
    var eksi = el - header -footer;
    let halfHeight = Math.max(0, (eksi) / 2)-5;

    var cardsrow = $(this).find(".row.cards-row");
    cardsrow.css("height", halfHeight);

    var hel = halfHeight
    var cardcol = $(this).find(".row.cards-row .col-md-2");
    cardcol.css("height", halfHeight);

    var cards2 = $(this).find(".row.tabulator-row");
    cards2.css("height", halfHeight);
  
    var tableMeydan = new Tabulator("#tableMeydan", {
      height: (halfHeight-70),
      layout:"fitColumns",
      placeholder:"Meydan Kalıp Liste",
      progressiveLoad:"scroll",
      paginationMode:"remote",
      paginationSize:10,
      filterMode: "remote",
      ajaxURL:"/kalipfirini/meydan",
      ajaxURLGenerator:function(url, config, params){
          return url + "?params=" + encodeURI(JSON.stringify(params)); //encode parameters as a json object
      },
      columns: [
        {title:"Kalıp No", field:"kalipNo",  headerFilter:"input", cellClick:function(e, cell){
          let kalip = cell.getData().kalipNo;
          document.getElementById("kalipNo").value = kalip;
          $('#kalipModal').modal('show');
        }},],});

  };



  const loadPage = () => {
    $.ajax({
      url: `/kalipfirini/goz`,
      method: 'GET',
      dataType: 'json',
      success: function (data) {
        console.log(data);
        if (data.length !=0){
          data = JSON.parse(data);
        }
        renderData(data);
      },
      error: function (data) {
        alert(data.responseJSON.error);
      }
    });
  };


  $(document).ready(function() {

    
  });
  
  btnFirinaEkle = document.getElementById('btnFirinaEkle');
  btnFirinaEkle.addEventListener('click', () => {
    let firinNo = document.getElementById('firinNo').value;
    if (firinNo != "" ){
      PostForm();
      $('#kalipModal').modal('hide');
    }
    else {
      alert("Lütfen göz seçiniz!");
    }
  });

  function PostForm (){
    $.ajax({
        url: '/kalipfirini/goz',
        type: 'post',
        data: $('#ekleForm').serialize(),
        success: function(data){
            alert(data.message);
            loadPage();
        },
        error: function (data) {
          alert(data.responseJSON.error);
        }
    });
    };

  $('input[type=radio][name=foo]').change(function() {
    var firin = document.getElementById('firinNo');
    firin.value = this.value;
  });

  loadPage();
</script>

{% endblock %}

{% block javascript %}
  {% include 'adminlte/lib/_scripts.html' %}
  <script src="{% static 'tabulator/dist/js/tabulator.js' %} "></script>

{% endblock %}
