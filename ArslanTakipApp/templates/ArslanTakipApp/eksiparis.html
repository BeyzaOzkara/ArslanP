{% extends 'adminlte/base.html' %}
{% block body_class %}
  {% block bodyclass %}
    sidebar-collapse
  {% endblock %}
{% endblock %}

{% load static %}

{% block title %}
  Arslan Alüminyum
{% endblock %}

{% block stylesheets %}
  {% include 'adminlte/lib/_styles.html' %}
  <link rel="stylesheet" type="text/css" href="{% static 'tabulator/dist/css/tabulator_bootstrap5.min.css' %}">
{% endblock %}

{% block content %}

<div class="container col-lg-12">
  <h1 class="col-lg-11" style="text-align: center;">Arslan Alüminyum Ek Sipariş Listesi</h1>
  <h2 class="col-lg-11" style="text-align: center;">YAPIM AŞAMASINDA (design)</h2>
  <button type="button" id="btnAcilListeDuzenle" class="btn btn-info" >Acil Listesi Düzenle</button>
  <div id="ekSiparisTable"></div>
  <div class="modal fade" id="acilModal" tabindex="-1" aria-labelledby="acilModalLabel" style="display: none;" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Acil Listesi Düzenle</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          {% csrf_token %}
          <!-- bütün ek siparis listesi movable row tabulator -->
          <div id="ekSiparisAcilTable"></div>
        </div>
        <div class="modal-footer">
          <button type="button" id="btnAcilListeKaydet" class="btn btn-primary">Kaydet</button>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}

<script>

  var headerMenu = function(){
    var menu = [];
    var columns = this.getColumns();

    for(let column of columns){
        if (column.getDefinition().title != ""){
        //create checkbox element using font awesome icons
            let icon = document.createElement("i");
            icon.classList.add("fas");
            
            icon.classList.add(column.isVisible() ? "fa-check-square" : "fa-square");
            
            //build label
            let label = document.createElement("span");
            let title = document.createElement("span");

            
            title.textContent = " " + column.getDefinition().title;
            label.appendChild(icon);
            label.appendChild(title);

            //create menu item
            menu.push({
                label:label,
                action:function(e){
                    //prevent menu closing
                    e.stopPropagation();
                    //toggle current column visibility
                    column.toggle();

                    //change menu item icon
                    if(column.isVisible()){
                        icon.classList.remove("fa-square");
                        icon.classList.add("fa-check-square");
                    }else{
                        icon.classList.remove("fa-check-square");
                        icon.classList.add("fa-square");
                    }
                }
            });
    }};

    return menu;
  };
  var handleIcon = function(cell, formatterParams, onRendered){ 
      return "<i class='fa fa-grip-vertical'></i>";
  };

  var ekSiparisTable = new Tabulator("#ekSiparisTable", {
    height:"700px",
    layout:"fitDataFill",
    placeholder:"Ek Sipariş Liste",
    ajaxURL:"/eksiparis/list",
    ajaxURLGenerator:function(url, config, params){
        return url + "?params=" + encodeURI(JSON.stringify(params)); //encode parameters as a json object
    },
    progressiveLoad:"scroll",
    paginationMode:"remote",
    filterMode:"remote",
    paginationSize:30,
    popupContainer:true,
    columns:[
        // sil ve siparistamam ikonu ekle
        {formatter:handleIcon, headerMenu:headerMenu, headerSort:false, frozen:true, width:30, minWidth:30},
        {title:"Kart No", field:"SipKartNo"},
        {title:"Profil No", field:"ProfilNo"},
        // ne kadar üretim yapılmış nasıl hesaplanacak?
        // ek sipariş eklenme gününü tut, pres üretim raporunda o tarihten sonra, o profil noda yapılan üretimler??
        // data-max = ek kg ve ek kalan kgye göre progress olabilir tamamlandı tamamlanmadı yeşil renk bloke kırmızı renk
        {title:"Sipariş Tamam", field:"EkSiparisTamam", visible:false, editor:"list", editorParams:{values:{"Evet":"EVET", "Hayır":"HAYIR", "Bloke":"BLOKE"}}},
        {title:"Ek Pres Kodu", field:"EkPresKodu"},
        {title:"Ek Termin", field:"EkTermin"},
        {title:"Ek Kg", field:"EkKg"},
        {title:"Firma Adı", field:"FirmaAdi", visible:false},
        {title:"Billet Türü", field:"BilletTuru"},
        {title:"Son Termin", field:"SonTermin", visible:false},
        {title:"Sipariş Kg", field:"GirenKg"},
        {title:"Kalan Kg", field:"Kg"},
        {title:"Kondüsyon Türü", field:"KondusyonTuru"},
        {title:"Toplam Kalan Tenifer", field:"TopTenKg", visible:false},
    ],
  });

  btnAcilListe = document.getElementById('btnAcilListeDuzenle');
  btnAcilListe.addEventListener('click', () => {
    $('#acilModal').modal('show');
    let data = ekSiparisAcilTable.getData();
    console.log(data);
  });

  var ekSiparisAcilTable = new Tabulator("#ekSiparisAcilTable", {
    height:"700px",
    layout:"fitDataFill",
    placeholder:"Ek Sipariş Acil Liste",
    ajaxURL:"/eksiparis/acil",
    popupContainer:true,
    movableRows:true,
    columns:[
        {rowHandle:true, formatter:"handle", title:"", headerMenu:headerMenu, headerSort:false, frozen:true, width:30, minWidth:30},
        {title:"Kart No", field:"SipKartNo"},
        {title:"Profil No", field:"ProfilNo"},
        {title:"Durumu", field:"EkDurumu", visible:false},
        {title:"Ek Pres Kodu", field:"EkPresKodu", visible:false},
        {title:"Ek Termin", field:"EkTermin"},
        {title:"Ek Kg", field:"EkKg"},
        {title:"Firma Adı", field:"FirmaAdi"},
        {title:"Billet Türü", field:"BilletTuru", visible:false},
        {title:"Son Termin", field:"SonTermin", visible:false},
        {title:"Sipariş Kg", field:"GirenKg", visible:false},
        {title:"Kalan Kg", field:"Kg", visible:false},
        {title:"Kondüsyon Türü", field:"KondusyonTuru", visible:false},
        {title:"Toplam Kalan Tenifer", field:"TopTenKg", visible:false},
    ],
  });

  var movedData = {}
  ekSiparisAcilTable.on("rowMoved", function(row){
      console.log("row moved");
      movedData = {};
      let rows = ekSiparisAcilTable.getRows();
      rows.forEach(r => {
        movedData[r._row.data.id] = r.getPosition();
        console.log(movedData)
    });
    movedDataUpdate();
  });

  let fark = [];
  const movedDataUpdate = () => {
    let data = ekSiparisAcilTable.getData();
    fark = [];
    data.forEach(d => {
      if (movedData[d.id] != d.Sira) {
        ekSiparisAcilTable.updateData([{id:d.id, Sira:movedData[d.id]}]);
        fark.push({id: d.id , Sira: movedData[d.id]});
      }
    });
  };

  btnAcilKaydet = document.getElementById('btnAcilListeKaydet');
  btnAcilKaydet.addEventListener('click', () => {
    $.ajax({
      url: "/eksiparis/acil",
      method: "post",
      data: {
        'fark': JSON.stringify(fark),
        'csrfmiddlewaretoken': '{{ csrf_token }}'
      },
      success: function () {
        console.log("gerceklesti");
        ekSiparisTable.setData();
        $('#acilModal').modal('hide');
        //alert("Acil Liste Kaydedildi!");
      },
      error: function (error) {
      console.error('Error sending moved rows data:', error);
      }
    });
  });
  

</script>

{% endblock %}

{% block javascript %}
{% include 'adminlte/lib/_scripts.html' %}
<script src="{% static 'tabulator/dist/js/tabulator.js' %} "></script>

{% endblock %}
